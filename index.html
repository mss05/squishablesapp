<!-- 
    ============================================================================
    PROJE: SQUISHABLES LEARNING APP - BUDDY SYSTEM FIX
    S√úR√úM: 7.0 (BUDDY & AVATAR SEPARATION)
    
    YAPILANDIRMA:
    - Avatar: Kullanƒ±cƒ±nƒ±n profil resmi (Dijital)
    - Buddy: Kullanƒ±cƒ±nƒ±n hamurdan yaptƒ±ƒüƒ± ve fotoƒürafƒ±nƒ± √ßektiƒüi arkada≈ü (Ger√ßek)
    - Bu iki g√∂rsel artƒ±k birbirine karƒ±≈ümayacak.
    
    BEKLENEN DOSYALAR (index.html ile aynƒ± dizinde):
    - logo.png, Product1.jpg
    - avatar1.png, avatar2.png, avatar3.png
    - cicek_adim1.jpg ... cicek_adim5.jpg
    - kale_adim1.jpg, kale_adim2.jpg
    - hayvan_adim1.jpg
    ============================================================================
-->

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squishables - Yaratƒ±cƒ± √ñƒürenme</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#C4DFD9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="logo.png">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS AYARLARI --- */
        :root {
            --primary: #C4DFD9; --primary-dark: #2e5c4d;
            --secondary: #FFD1BA; --secondary-dark: #d68c6d;
            --accent: #DCD6F7; --accent-dark: #424874;
            --bg-body: #f4f7f6; --white: #ffffff;
            --text-main: #2D3436; --text-muted: #636E72;
            --success: #00b894; --warning: #fdcb6e; --danger: #ff7675; --gold: #FFD700;
            --shadow-card: 0 8px 20px rgba(0,0,0,0.06);
            --trans-fast: 0.2s ease;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Nunito', sans-serif; background-color: var(--bg-body); display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; overflow: hidden; color: var(--text-main); }
        ::-webkit-scrollbar { display: none; }

        #app-frame { width: 100%; max-width: 414px; height: 100%; max-height: 896px; background-color: var(--white); position: relative; overflow: hidden; display: flex; flex-direction: column; transition: 0.4s ease; }
        @media (min-width: 450px) {
            #app-frame { height: 85vh; border-radius: 45px; border: 14px solid #2d3436; box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
            .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 160px; height: 32px; background: #2d3436; border-radius: 0 0 24px 24px; z-index: 9999; }
        }

        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: none; flex-direction: column; animation: fadeIn 0.4s ease forwards; z-index: 10; }
        .screen.active { display: flex; }
        .scroll-content { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 130px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }

        /* UI */
        h1, h2, h3 { font-family: 'Fredoka', sans-serif; margin: 0; }
        .btn { border: none; padding: 18px; width: 100%; border-radius: 22px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: var(--trans-fast); display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Fredoka', sans-serif; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: #333; box-shadow: 0 8px 20px rgba(196, 223, 217, 0.4); }
        .btn-secondary { background: white; color: var(--text-muted); border: 2px solid #eee; }
        
        .card { background: white; border-radius: 28px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.03); box-shadow: var(--shadow-card); position: relative; overflow: hidden; transition: var(--trans-fast); }
        .card:active { transform: scale(0.98); background: #fdfdfd; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; height: 80px; }
        .back-btn { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #f5f6fa; color: var(--text-main); font-size: 1.1rem; cursor: pointer; }

        /* TOAST */
        #toast-container { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; pointer-events: none; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(45, 52, 54, 0.95); color: white; padding: 14px 20px; border-radius: 30px; text-align: center; opacity: 0; transform: translateY(-30px) scale(0.9); transition: 0.4s; font-size: 0.95rem; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 12px; backdrop-filter: blur(8px); }
        .toast.show { opacity: 1; transform: translateY(0) scale(1); }
        .toast.success { background: var(--primary-dark); }
        .toast.error { background: var(--danger); }

        /* MODAL */
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 88%; max-height: 85%; overflow-y: auto; padding: 30px; border-radius: 35px; text-align: center; animation: popIn 0.4s; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #f5f6fa; border-radius: 50%; }

        /* SAYFA STƒ∞LLERƒ∞ */
        .product-hero { width: 100%; height: 260px; border-radius: 35px; overflow: hidden; margin-bottom: 25px; position: relative; background: white; border: 1px solid rgba(0,0,0,0.05); box-shadow: var(--shadow-card); }
        .product-hero img { width: 100%; height: 100%; object-fit: contain; padding: 20px; }
        
        .avatar-grid { display: flex; gap: 15px; justify-content: center; margin: 30px 0; }
        .avatar-opt { width: 85px; height: 85px; border-radius: 50%; border: 4px solid white; cursor: pointer; object-fit: cover; transition: var(--trans-fast); background: #eee; box-shadow: var(--shadow-card); }
        .avatar-opt.selected { border-color: var(--text-main); transform: scale(1.15); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .custom-input { width: 100%; padding: 18px 20px; background: white; border: 2px solid #eee; border-radius: 20px; margin-bottom: 20px; font-family: 'Nunito'; font-size: 1.05rem; transition: 0.2s; outline: none; color: var(--text-main); }
        .custom-input:focus { border-color: var(--primary); }

        .progress-bar { width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px; margin-bottom: 25px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-dark); width: 0%; transition: width 0.5s; border-radius: 5px; }
        .step-image-box { width: 100%; height: 220px; background: white; border-radius: 28px; display: flex; align-items: center; justify-content: center; border: 2px solid #f0f0f0; overflow: hidden; position: relative; margin-bottom: 15px; box-shadow: var(--shadow-card); }
        .step-image-box img { width: 100%; height: 100%; object-fit: cover; }
        .guide-label { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.75); color: white; padding: 6px 14px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; z-index: 2; pointer-events: none; }
        
        .lesson-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lesson-card { background: white; border-radius: 24px; padding: 25px 15px; text-align: center; cursor: pointer; transition: var(--trans-fast); border: 2px solid transparent; box-shadow: var(--shadow-card); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; gap: 15px; }
        .lesson-card:active { transform: scale(0.96); border-color: var(--primary); }
        .lesson-card i { font-size: 2.5rem; }
        
        .level-map { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 30px 10px; }
        .level-node { aspect-ratio: 1; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 800; font-size: 1.4rem; cursor: pointer; position: relative; background: #e0e0e0; color: #a4b0be; border: 3px solid transparent; transition: 0.2s; }
        .level-node.unlocked { background: white; color: var(--text-main); border-color: #eee; box-shadow: var(--shadow-card); }
        .level-node.completed { background: var(--primary); color: #333; border-color: var(--primary-dark); }
        .level-stars { display: flex; gap: 2px; font-size: 0.7rem; color: var(--gold); margin-top: 5px; }

        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: 95px; background: rgba(255,255,255,0.98); display: flex; justify-content: space-around; align-items: center; padding-bottom: 25px; z-index: 200; box-shadow: 0 -10px 40px rgba(0,0,0,0.05); border-radius: 40px 40px 0 0; backdrop-filter: blur(10px); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: #b2bec3; font-size: 0.75rem; cursor: pointer; width: 25%; transition: 0.3s; position: relative; font-weight: 600; }
        .nav-item.active { color: var(--text-main); }
        .nav-item.active i { transform: translateY(-5px); color: var(--primary-dark); }
        .nav-item i { font-size: 1.6rem; transition: 0.3s; }

        /* Quiz UI */
        .option-btn { background: white; border: 2px solid #f0f0f0; padding: 25px; border-radius: 22px; font-size: 1.4rem; font-weight: 700; color: var(--text-main); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-card); }
        .option-btn:active { transform: scale(0.96); background: #f9f9f9; border-color: #ddd; }
        
        /* Buddy Widget */
        .buddy-corner { position: absolute; bottom: 130px; left: 20px; display: flex; align-items: flex-end; z-index: 50; pointer-events: none; }
        .buddy-avatar-small { width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.15); background: white; object-fit: cover; }
        .buddy-bubble { background: white; padding: 12px 18px; border-radius: 20px 20px 20px 0; box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-size: 0.9rem; color: var(--text-main); max-width: 200px; margin-bottom: 20px; margin-left: 15px; font-weight: 600; animation: popIn 0.3s ease; transform-origin: bottom left; }

        @keyframes popIn { 0% {transform: scale(0.9); opacity: 0;} 100% {transform: scale(1); opacity: 1;} }
        @keyframes fadeIn { 0% {opacity: 0;} 100% {opacity: 1;} }
    </style>
</head>
<body>

<div id="app-frame">
    <div class="notch"></div>
    <div id="toast-container"></div>
    <canvas id="confetti-canvas" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1500;"></canvas>

    <!-- MODAL: AYARLAR -->
    <div id="settings-modal" class="modal-overlay" onclick="closeModal('settings-modal')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h2 style="margin-bottom:25px;">Ayarlar</h2>
            <button class="btn-text" style="width:100%; margin-top:10px; color:var(--danger);" onclick="resetProgress()">
                <i class="fa-solid fa-trash-can"></i> ƒ∞lerlemeyi Sƒ±fƒ±rla
            </button>
            <button class="btn-primary" style="margin-top:20px;" onclick="closeModal('settings-modal')">Kapat</button>
        </div>
    </div>

    <!-- EKRAN 1: SPLASH -->
    <div id="s-splash" class="screen active" style="align-items:center; justify-content:center; background:var(--bg-body);">
        <img src="logo.png" alt="Logo" style="width:160px; height:160px; object-fit:cover; border-radius:35px; box-shadow:var(--shadow-card); margin-bottom:30px; animation:popIn 1s;" onerror="this.src='https://placehold.co/150x150?text=Logo';">
        <h1 style="color:var(--text-main); font-size:2.2rem; font-weight:800;">Squishables</h1>
        <p>Yaratƒ±cƒ±lƒ±ƒüƒ±n Dokunu≈üu</p>
        <div style="margin-top:50px;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:2.5rem; color:var(--primary-dark);"></i></div>
        <button id="force-start-btn" class="btn-primary" style="display:none; width:auto; padding:12px 30px; margin-top:30px; position:absolute; bottom:50px;" onclick="nav('s-onboarding')">Uygulamayƒ± Ba≈ülat</button>
    </div>

    <!-- EKRAN 2: ONBOARDING -->
    <div id="s-onboarding" class="screen" style="padding:0;">
        <div class="product-hero" style="height:60%; border-radius:0 0 50px 50px; border:none; margin:0; background:white; box-shadow:var(--shadow-float);">
            <img src="Product1.jpg" style="width:100%; height:100%; object-fit:contain; padding:40px;" onerror="this.src='https://placehold.co/400x400?text=Urun+Gorseli';">
        </div>
        <div style="padding:40px 30px; text-align:center; flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h1 style="font-size:2.2rem; margin-bottom:15px; color:var(--text-main);">Aile Baƒülarƒ± Kiti</h1>
            <p style="font-size:1.1rem; margin-bottom:30px;">Bu kutu ile ailecek hem √∂ƒürenin, hem eƒülenin.</p>
            <button class="btn-primary" style="box-shadow:var(--shadow-card);" onclick="nav('s-profile-setup')">Hadi Ba≈ülayalƒ±m! <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>

    <!-- EKRAN 3: PROFIL KURULUMU (ZORUNLU) -->
    <div id="s-profile-setup" class="screen">
        <div class="header">
            <div class="back-btn" onclick="nav('s-onboarding')"><i class="fa-solid fa-chevron-left"></i></div>
            <h3>Profilini Yarat</h3><div style="width:40px;"></div>
        </div>
        <div class="scroll-content">
            <div style="text-align:center; margin:20px 0 40px 0;">
                <p style="font-weight:700; margin-bottom:20px; font-size:1.1rem;">Seni en iyi yansƒ±tan hangisi?</p>
                <div class="avatar-grid">
                    <img src="avatar1.png" class="avatar-opt selected" onclick="pickAvatar(this, 'avatar1.png')" onerror="this.src='https://placehold.co/100x100?text=A1';">
                    <img src="avatar2.png" class="avatar-opt" onclick="pickAvatar(this, 'avatar2.png')" onerror="this.src='https://placehold.co/100x100?text=A2';">
                    <img src="avatar3.png" class="avatar-opt" onclick="pickAvatar(this, 'avatar3.png')" onerror="this.src='https://placehold.co/100x100?text=A3';">
                </div>
            </div>
            <div class="input-group"><label style="font-weight:800; margin-bottom:8px; display:block;">ƒ∞smin Nedir?</label><input type="text" id="inp-name" class="custom-input" placeholder="√ñrn: Deniz"></div>
            <div class="input-group"><label style="font-weight:800; margin-bottom:8px; display:block;">Ka√ß Ya≈üƒ±ndasƒ±n?</label><input type="number" class="custom-input" placeholder="5"></div>
        </div>
        <div style="padding:30px;">
            <!-- BUTON FIX: saveProfileAndStart fonksiyonu -->
            <button class="btn-primary" onclick="saveProfileAndStart()">Maceraya Atƒ±l üöÄ</button>
        </div>
    </div>

    <!-- EKRAN 4: ANA SAYFA -->
    <div id="s-home" class="screen">
        <div class="header">
            <div style="display:flex; align-items:center; gap:15px;">
                <img id="home-header-avatar" src="avatar1.png" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid var(--primary);" onerror="this.src='https://placehold.co/50x50';">
                <div><p style="margin:0; font-size:0.8rem; font-weight:600;">Merhaba,</p><h3 style="margin:0; font-size:1.2rem; color:var(--primary-dark);" id="home-name-display">Arkada≈üƒ±m</h3></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="back-btn" onclick="document.getElementById('settings-modal').style.display='flex'"><i class="fa-solid fa-gear"></i></div>
            </div>
        </div>
        <div class="scroll-content">
            <h3 style="margin:10px 0 15px 0; font-size:1.3rem;">Kutunun ƒ∞√ßindekiler</h3>
            <div class="product-hero" style="height:200px;" onclick="nav('s-challenges')">
                <img src="Product1.jpg" onerror="this.src='https://placehold.co/400x200?text=Urun+Kutusu';">
            </div>

            <h3 style="margin:25px 0 15px 0; font-size:1.3rem;">Hƒ±zlƒ± Eri≈üim</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div class="card" style="flex-direction:column; padding:25px; border-bottom:5px solid var(--secondary-dark); min-height:160px; justify-content:center;" onclick="nav('s-lessons')">
                    <div style="background:var(--secondary); width:65px; height:65px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; margin-bottom:15px; color:var(--secondary-dark);"><i class="fa-solid fa-book-open"></i></div><b>Dersler</b>
                </div>
                <div class="card" style="flex-direction:column; padding:25px; border-bottom:5px solid var(--primary-dark); min-height:160px; justify-content:center;" onclick="nav('s-challenges')">
                    <div style="background:var(--primary); width:65px; height:65px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; margin-bottom:15px; color:var(--primary-dark);"><i class="fa-solid fa-palette"></i></div><b>Rehberler</b>
                </div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('s-home')"><i class="fa-solid fa-house"></i>Ev</div>
            <div class="nav-item" onclick="nav('s-lessons')"><i class="fa-solid fa-book"></i>Ders</div>
            <div class="nav-item" onclick="nav('s-challenges')"><i class="fa-solid fa-hammer"></i>Yap</div>
            <div class="nav-item" onclick="nav('s-rewards')"><i class="fa-solid fa-user"></i>Ben</div>
        </div>
    </div>

    <!-- EKRAN 5: DERSLER (BUDDY Y√úKLEME BURADA) -->
    <div id="s-lessons" class="screen">
        <div class="header"><h3>Dersler</h3></div>
        <div class="scroll-content">
            <!-- BUDDY CARD -->
            <div class="card" style="background:#fff0f5; border-left:5px solid #e84393; display:flex; align-items:center; justify-content:space-between; cursor:pointer;" onclick="setupBuddy()">
                <div>
                    <h3 style="margin:0; font-size:1.1rem; color:#d63031;">√áalƒ±≈üma Arkada≈üƒ±</h3>
                    <p style="margin:5px 0 0 0; font-size:0.8rem;">Hamurdan arkada≈üƒ±nƒ± y√ºkle!</p>
                </div>
                <div style="position:relative;">
                    <img id="lesson-buddy-preview" src="https://placehold.co/60x60?text=?" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid white;">
                    <div style="position:absolute; bottom:-5px; right:-5px; background:white; border-radius:50%; padding:5px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fa-solid fa-camera" style="font-size:0.8rem; color:#e84393;"></i>
                    </div>
                </div>
                <input type="file" id="buddy-upload" style="display:none;" accept="image/*" onchange="handleBuddyUpload(this)">
            </div>

            <p style="margin:20px 0;">Konu Se√ß:</p>
            <div class="lesson-grid">
                <div class="lesson-card" onclick="openLevelMap('math')"><i class="fa-solid fa-calculator" style="color:var(--accent-dark);"></i><b>Matematik</b><small style="color:var(--success);">10 Seviye</small></div>
                <div class="lesson-card" onclick="openLevelMap('colors')"><i class="fa-solid fa-palette" style="color:var(--secondary-dark);"></i><b>Renkler</b><small style="color:var(--success);">10 Seviye</small></div>
                <div class="lesson-card" onclick="openLevelMap('shapes')"><i class="fa-solid fa-shapes" style="color:var(--primary-dark);"></i><b>≈ûekiller</b><small style="color:var(--success);">10 Seviye</small></div>
                <div class="lesson-card" onclick="openLevelMap('space')"><i class="fa-solid fa-rocket" style="color:#0984e3;"></i><b>Uzay</b><small style="color:var(--success);">10 Seviye</small></div>
                <div class="lesson-card" onclick="openLevelMap('music')"><i class="fa-solid fa-music" style="color:#fd79a8;"></i><b>M√ºzik</b><small style="color:var(--success);">10 Seviye</small></div>
                <div class="lesson-card" onclick="openLevelMap('animals')"><i class="fa-solid fa-paw" style="color:#e17055;"></i><b>Hayvanlar</b><small style="color:var(--success);">10 Seviye</small></div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item" onclick="nav('s-home')"><i class="fa-solid fa-house"></i>Ev</div>
            <div class="nav-item active" onclick="nav('s-lessons')"><i class="fa-solid fa-book"></i>Ders</div>
            <div class="nav-item" onclick="nav('s-challenges')"><i class="fa-solid fa-hammer"></i>Yap</div>
            <div class="nav-item" onclick="nav('s-rewards')"><i class="fa-solid fa-user"></i>Ben</div>
        </div>
    </div>

    <!-- EKRAN 6: SEVƒ∞YE HARƒ∞TASI -->
    <div id="s-level-map" class="screen">
        <div class="header"><div class="back-btn" onclick="nav('s-lessons')"><i class="fa-solid fa-chevron-left"></i></div><h3 id="map-title">Matematik</h3><div style="width:40px;"></div></div>
        <div class="scroll-content" style="text-align:center;">
            <div style="background:white; padding:20px; border-radius:20px; margin-bottom:20px; box-shadow:var(--shadow-sm);"><i class="fa-solid fa-star" style="color:var(--gold); font-size:2rem; margin-bottom:10px;"></i><p>Sƒ±rayla t√ºm yƒ±ldƒ±zlarƒ± topla!</p></div>
            <div class="level-map" id="level-grid-container"></div>
        </div>
    </div>

    <!-- EKRAN 7: QUIZ -->
    <div id="s-quiz" class="screen">
        <div class="header"><div class="back-btn" onclick="nav('s-level-map')"><i class="fa-solid fa-xmark" style="color:var(--danger);"></i></div><h3 id="quiz-level-ind">Level 1</h3><div style="width:40px;"></div></div>
        <div class="scroll-content" style="display:flex; flex-direction:column; justify-content:center; padding-top:40px;">
            <div class="quiz-timer"><div class="quiz-timer-fill" id="timer-bar"></div></div>
            <div style="text-align:center; margin-bottom:50px;"><h1 style="font-size:3rem; color:var(--text-main); margin-bottom:15px; font-weight:800;" id="quiz-question">?</h1><p style="font-size:1.1rem;">Doƒüru cevabƒ± se√ß!</p></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;" id="quiz-options"></div>
            
            <!-- BUDDY G√ñR√úN√úM√ú -->
            <div class="buddy-corner">
                <div class="buddy-bubble" id="quiz-buddy-msg">Ba≈üarƒ±lar!</div>
                <img id="quiz-buddy-img" src="" class="buddy-avatar-small" onerror="this.style.display='none'">
            </div>
        </div>
    </div>

    <!-- EKRAN 8: REHBERLER -->
    <div id="s-challenges" class="screen">
        <div class="header"><h3>Rehberler</h3></div>
        <div class="scroll-content">
            <p class="mb-20">Kutundaki malzemelerle neler yapabilirsin?</p>
            <div class="card" onclick="startGuide('flower')" style="padding:0; min-height:auto;">
                <div style="height:140px; width:100%; background:#ffeaa7; display:flex; align-items:center; justify-content:center; font-size:5rem;">üå∏</div>
                <div style="padding:20px; width:100%; display:flex; align-items:center; justify-content:space-between;"><div><h3 style="margin:0;">√ái√ßek Yap</h3><p style="margin:5px 0 0 0;">5 Adƒ±m ‚Ä¢ Kolay</p></div><button class="btn-primary" style="width:auto; padding:10px 25px;">Ba≈üla</button></div>
            </div>
            <div class="card" onclick="startGuide('castle')" style="padding:0; min-height:auto;">
                <div style="height:140px; width:100%; background:#74b9ff; display:flex; align-items:center; justify-content:center; font-size:5rem;">üè∞</div>
                <div style="padding:20px; width:100%; display:flex; align-items:center; justify-content:space-between;"><div><h3 style="margin:0;">Kale Yap</h3><p style="margin:5px 0 0 0;">2 Adƒ±m ‚Ä¢ Orta</p></div><button class="btn-primary" style="width:auto; padding:10px 25px;">Ba≈üla</button></div>
            </div>
            <div class="card" onclick="startGuide('animal')" style="padding:0; min-height:auto;">
                <div style="height:140px; width:100%; background:#a29bfe; display:flex; align-items:center; justify-content:center; font-size:5rem;">ü¶Å</div>
                <div style="padding:20px; width:100%; display:flex; align-items:center; justify-content:space-between;"><div><h3 style="margin:0;">Hayvan Yap</h3><p style="margin:5px 0 0 0;">1 Adƒ±m ‚Ä¢ Kolay</p></div><button class="btn-primary" style="width:auto; padding:10px 25px;">Ba≈üla</button></div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item" onclick="nav('s-home')"><i class="fa-solid fa-house"></i>Ev</div>
            <div class="nav-item" onclick="nav('s-lessons')"><i class="fa-solid fa-book"></i>Ders</div>
            <div class="nav-item active" onclick="nav('s-challenges')"><i class="fa-solid fa-hammer"></i>Yap</div>
            <div class="nav-item" onclick="nav('s-rewards')"><i class="fa-solid fa-user"></i>Ben</div>
        </div>
    </div>

    <!-- EKRAN 9: GUIDE ADIMLARI -->
    <div id="s-guide-steps" class="screen">
        <div class="header"><div class="back-btn" onclick="nav('s-challenges')"><i class="fa-solid fa-xmark"></i></div><h3 id="guide-step-header">Adƒ±m 1/5</h3><div style="width:40px;"></div></div>
        <div class="scroll-content" style="text-align:center;">
            <div class="step-progress"><div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div></div>
            <div class="step-image-box"><div class="guide-label">√ñrnek</div><img id="guide-example-img" src="" alt="√ñrnek" onerror="this.src='https://placehold.co/400x200?text=Ornek+Yok';"></div>
            <div class="step-image-box" id="guide-user-box" style="display:none; border-color:var(--primary); height:220px;"><div class="guide-label user"><i class="fa-solid fa-user"></i> Senin Eserin</div><img id="guide-user-img" src=""></div>
            <div style="text-align:center; margin:25px 0;"><h2 id="guide-step-title" style="margin-bottom:10px;">Ba≈ülƒ±k</h2><p id="guide-step-desc">A√ßƒ±klama</p></div>
            <div class="step-upload-btn" onclick="document.getElementById('guide-file-input').click()"><i class="fa-solid fa-camera" style="font-size:2rem; margin-bottom:10px; color:var(--text-muted);"></i><div style="font-weight:700;">Fotoƒüraf √áek / Y√ºkle</div><small>Devam etmek i√ßin y√ºklemelisin</small></div>
            <input type="file" id="guide-file-input" style="display:none;" accept="image/*" onchange="handlePhotoUpload(this)">
            <div style="display:flex; gap:15px; margin-top:30px;">
                <button class="btn-secondary" style="flex:1;" onclick="prevStep()">Geri</button>
                <button class="btn-primary" style="flex:2;" id="btn-guide-next" onclick="nextStep()">ƒ∞leri <i class="fa-solid fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <!-- EKRAN 10: GUIDE BA≈ûARI -->
    <div id="s-guide-success" class="screen" style="text-align:center; padding:30px;">
        <div style="margin-top:40px; margin-bottom:20px;">
            <div style="width:120px; height:120px; background:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:3.5rem; margin:0 auto; animation:popIn 0.5s; box-shadow:0 10px 30px rgba(0,184,148,0.4);"><i class="fa-solid fa-check"></i></div>
        </div>
        <h1 style="font-size:2.5rem; margin-bottom:10px;">Harika ƒ∞≈ü!</h1><p>ƒ∞≈üte yaratƒ±cƒ±lƒ±ƒüƒ±nƒ±n hikayesi:</p>
        <div class="scroll-content" style="flex:1; padding:20px 0;"><div class="summary-grid" id="summary-grid" style="display:flex; flex-direction:column; gap:15px;"></div></div>
        <div style="padding:20px 0;"><button class="btn-primary" onclick="claimGuideReward()">√ñd√ºl√ºn√º Al (+50 XP) <i class="fa-solid fa-gift"></i></button></div>
    </div>

    <!-- EKRAN 11: PROFƒ∞L -->
    <div id="s-rewards" class="screen">
        <div class="scroll-content" style="padding:0;">
            <div style="background:white; padding:40px 20px; border-radius:0 0 40px 40px; text-align:center; box-shadow:var(--shadow-card); margin-bottom:25px;">
                <img id="profile-avatar-display" src="" style="width:100px; height:100px; border-radius:50%; border:5px solid var(--primary); object-fit:cover;">
                <h2 style="margin-top:15px;" id="profile-name-display">ƒ∞simsiz</h2>
                <p>Usta Yaratƒ±cƒ±</p>
                <div style="display:flex; justify-content:center; gap:20px; margin-top:20px;">
                    <div style="background:#f9f9f9; padding:10px 20px; border-radius:15px;">
                        <b style="font-size:1.2rem;" id="profile-lvl">1</b><br><small>Seviye</small>
                    </div>
                    <div style="background:#f9f9f9; padding:10px 20px; border-radius:15px;">
                        <b style="font-size:1.2rem;" id="profile-xp">0</b><br><small>XP</small>
                    </div>
                </div>
            </div>
            <div style="padding:0 25px;">
                <h3 style="margin-bottom:15px;">Rozetlerin</h3>
                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;">
                    <div class="card" style="text-align:center; padding:10px;"><div style="font-size:2rem;">ü•á</div><small>ƒ∞lk Adƒ±m</small></div>
                    <div class="card" style="text-align:center; padding:10px; opacity:0.5;"><div style="font-size:2rem;">üõ†Ô∏è</div><small>Usta</small></div>
                    <div class="card" style="text-align:center; padding:10px; opacity:0.5;"><div style="font-size:2rem;">üé®</div><small>Sanat√ßƒ±</small></div>
                </div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item" onclick="nav('s-home')"><i class="fa-solid fa-house"></i>Ev</div>
            <div class="nav-item" onclick="nav('s-lessons')"><i class="fa-solid fa-book"></i>Ders</div>
            <div class="nav-item" onclick="nav('s-challenges')"><i class="fa-solid fa-hammer"></i>Yap</div>
            <div class="nav-item active" onclick="nav('s-rewards')"><i class="fa-solid fa-user"></i>Ben</div>
        </div>
    </div>

</div>

<!-- KONFETƒ∞ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    /* ==================== JAVASCRIPT MANTIƒûI ==================== */
    
    // --- VERƒ∞ Y√ñNETƒ∞Mƒ∞ ---
    let user = {
        name: "",
        avatar: "avatar1.png",
        buddy: null, // Hamur arkada≈üƒ±
        xp: 0,
        level: 1,
        progress: {
            math: 1, colors: 1, shapes: 1, music: 1, space: 1, animals: 1
        }
    };

    // --- BA≈ûLATMA & VERƒ∞ Y√úKLEME ---
    window.onload = function() {
        try {
            const saved = localStorage.getItem('squish_user');
            if(saved) {
                user = JSON.parse(saved);
                nav('s-home');
            } else {
                nav('s-splash');
                setTimeout(() => nav('s-profile-create'), 2500);
            }
            updateUI();
            
            // Eƒüer splash'te takƒ±lƒ±rsa butonu g√∂ster
            setTimeout(() => {
                if(document.getElementById('s-splash').classList.contains('active')) {
                    document.getElementById('force-start-btn').style.display='block';
                }
            }, 3000);
        } catch(e) {
            console.error("Ba≈ülatma hatasƒ±", e);
            document.getElementById('force-start-btn').style.display='block';
        }
    };

    function save() {
        localStorage.setItem('squish_user', JSON.stringify(user));
        updateUI();
    }

    // --- UI G√úNCELLEME ---
    function updateUI() {
        // ƒ∞simler
        const nameEls = ['home-name-display', 'profile-name-display'];
        nameEls.forEach(id => { 
            const el = document.getElementById(id);
            if(el) el.innerText = user.name; 
        });
        
        // Avatarlar
        const avEls = ['header-avatar', 'profile-avatar-display'];
        avEls.forEach(id => { 
            const el = document.getElementById(id);
            if(el) el.src = user.avatar; 
        });
        
        // Buddy (Quizdeki)
        const quizBuddy = document.getElementById('quiz-buddy-img');
        if(quizBuddy) {
            if(user.buddy) {
                quizBuddy.src = user.buddy;
                quizBuddy.style.display = 'block';
            } else {
                // Eƒüer buddy yoksa avatarƒ± g√∂ster veya gizle (istediƒüin gibi ayarla)
                // quizBuddy.src = "https://placehold.co/100x100?text=No+Buddy";
                quizBuddy.style.display = 'none'; // ≈ûimdilik gizle
            }
        }
        
        // Buddy Preview (Ders men√ºs√ºndeki)
        const lessonBuddy = document.getElementById('lesson-buddy-preview');
        if(lessonBuddy && user.buddy) lessonBuddy.src = user.buddy;

        // Stats
        if(document.getElementById('home-lvl')) document.getElementById('home-lvl').innerText = user.level;
        if(document.getElementById('home-xp')) document.getElementById('home-xp').innerText = user.xp;
        if(document.getElementById('profile-lvl')) document.getElementById('profile-lvl').innerText = user.level;
        if(document.getElementById('profile-xp')) document.getElementById('profile-xp').innerText = user.xp;
        if(document.getElementById('dash-lvl')) document.getElementById('dash-lvl').innerText = user.level;
        
        if(document.getElementById('home-xp-bar')) document.getElementById('home-xp-bar').style.width = (user.xp % 100) + "%";
        if(document.getElementById('dash-xp-bar')) document.getElementById('dash-xp-bar').style.width = (user.xp % 100) + "%";
    }

    // --- NAVƒ∞GASYON ---
    function nav(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.style.display = 'none';
        });
        const target = document.getElementById(id);
        if(target) {
            target.style.display = 'flex';
            setTimeout(() => target.classList.add('active'), 10);
        }
        
        // Bottom Nav Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(id === 's-home') updateNav(0);
        if(id === 's-lessons') updateNav(1);
        if(id === 's-challenges') updateNav(2);
        if(id === 's-profile-view' || id === 's-rewards') updateNav(3);
    }
    function updateNav(i) {
        const items = document.querySelectorAll('.nav-item');
        if(items[i]) items[i].classList.add('active');
    }

    // --- PROFƒ∞L ---
    function selectAvatar(el, src) {
        document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
        el.classList.add('selected');
        user.avatar = src;
    }
    
    // BUTON D√úZELTMESƒ∞ BURADA
    function saveProfileAndStart() {
        try {
            const nameInput = document.getElementById('inp-name');
            if(nameInput && nameInput.value.trim() !== "") {
                user.name = nameInput.value;
            }
            save();
            showToast("Ho≈ü geldin!", "success");
            nav('s-home');
        } catch(e) {
            console.error("Save error", e);
            // Hata olsa bile ge√ß
            nav('s-home');
        }
    }

    function resetProgress() {
        if(confirm("Sƒ±fƒ±rlamak istiyor musun?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // --- BUDDY ---
    function setupBuddy() {
        document.getElementById('buddy-upload').click();
    }
    function handleBuddyUpload(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = function(e) {
                user.buddy = e.target.result;
                save();
                showToast("Hamur arkada≈üƒ±n kaydedildi!", "success");
            }
            r.readAsDataURL(input.files[0]);
        }
    }

    // --- LEVEL Sƒ∞STEMƒ∞ & SORU MOTORU ---
    let currentSubject = '';
    function openLevelMap(subject) {
        currentSubject = subject;
        const mapDiv = document.getElementById('level-grid-container');
        mapDiv.innerHTML = "";
        document.getElementById('map-title').innerText = subject.toUpperCase();
        
        const unlocked = user.progress[subject] || 1;

        for(let i=1; i<=10; i++) {
            let stateClass = "level-dot";
            if(i < unlocked) stateClass += " completed";
            else if(i === unlocked) stateClass += " unlocked";
            
            let div = document.createElement('div');
            div.className = "level-node " + stateClass;
            div.innerText = i;
            
            if(i <= unlocked) {
                div.onclick = () => startQuiz(i);
            } else {
                div.onclick = () => showToast("√ñnceki seviyeyi bitirmelisin!", "error");
            }
            mapDiv.appendChild(div);
        }
        nav('s-level-map');
    }

    // SORU √úRETƒ∞Cƒ∞
    function generateQuestion(type, lvl) {
        let q, ans, correct;
        
        // MATEMATƒ∞K
        if(type === 'math') {
            let max = lvl * 5; 
            let n1 = Math.floor(Math.random() * max) + 1;
            let n2 = Math.floor(Math.random() * max) + 1;
            
            if(lvl > 4) { // √áƒ±karma
                if(n1 < n2) { let temp = n1; n1 = n2; n2 = temp; } // Negatif olmasƒ±n
                q = `${n1} - ${n2} = ?`;
                correct = n1 - n2;
            } else { // Toplama
                q = `${n1} + ${n2} = ?`;
                correct = n1 + n2;
            }
            ans = [correct, correct+1, correct-1, correct+2];
        } 
        // RENKLER
        else if (type === 'colors') {
            const cols = [{n:"Kƒ±rmƒ±zƒ±", v:"üü•"}, {n:"Mavi", v:"üü¶"}, {n:"Sarƒ±", v:"üü®"}, {n:"Ye≈üil", v:"üü©"}, {n:"Mor", v:"üü™"}];
            let t = cols[Math.floor(Math.random() * cols.length)];
            q = `Hangisi ${t.n}?`;
            correct = t.v;
            ans = [t.v];
            while(ans.length < 4) {
                let r = cols[Math.floor(Math.random() * cols.length)].v;
                if(!ans.includes(r)) ans.push(r);
            }
        }
        // M√úZƒ∞K
        else if (type === 'music') {
            const items = ["Gitar üé∏", "Davul ü•Å", "Keman üéª", "Piyano üéπ", "Trompet üé∫"];
            let t = items[Math.floor(Math.random() * items.length)];
            q = `${t.split(' ')[0]} hangisi?`;
            correct = t.split(' ')[1];
            ans = [correct];
            while(ans.length < 4) {
                let r = items[Math.floor(Math.random() * items.length)].split(' ')[1];
                if(!ans.includes(r)) ans.push(r);
            }
        }
        // ... Diƒüer dersler i√ßin fallback
        else {
            q = "Deneme Soru"; correct = "A"; ans = ["A","B","C","D"];
        }
        
        // ≈ûƒ±klarƒ± karƒ±≈ütƒ±r
        ans.sort(() => Math.random() - 0.5);
        return { q, ans, correct };
    }

    function startQuiz(lvl) {
        const qData = generateQuestion(currentSubject, lvl);
        document.getElementById('q-text').innerText = qData.q;
        document.getElementById('quiz-title').innerText = `Level ${lvl}`;
        
        const grid = document.getElementById('q-options');
        grid.innerHTML = "";
        
        qData.ans.forEach(opt => {
            let btn = document.createElement('div');
            btn.className = 'quiz-option option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt == qData.correct) {
                    btn.style.background = "var(--success)";
                    btn.style.color = "white";
                    document.getElementById('quiz-buddy-msg').innerText = "Harika!";
                    setTimeout(() => {
                        if(lvl === user.progress[currentSubject]) {
                            user.progress[currentSubject]++;
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        }
                        user.xp += 10;
                        if(user.xp >= 100) { user.level++; user.xp = 0; showToast("Seviye Atladƒ±n!", "levelup"); }
                        save();
                        openLevelMap(currentSubject); 
                    }, 1000);
                } else {
                    btn.style.background = "var(--danger)";
                    btn.style.color = "white";
                    document.getElementById('quiz-buddy-msg').innerText = "Tekrar dene!";
                }
            };
            grid.appendChild(btn);
        });
        
        document.getElementById('quiz-buddy-msg').innerText = "Ba≈üarƒ±lar!";
        nav('s-quiz');
    }

    // --- REHBERLER ---
    let guidePhotos = [];
    let guideStepIndex = 0;
    let activeGuideKey = null;

    const guidesLocal = {
        flower: { title:"√ái√ßek", steps: [{t:"Adƒ±m 1", d:"Yap", img:"cicek_adim1.jpg"}, {t:"Adƒ±m 2", d:"Yap", img:"cicek_adim2.jpg"}, {t:"Adƒ±m 3", d:"Yap", img:"cicek_adim3.jpg"}, {t:"Adƒ±m 4", d:"Yap", img:"cicek_adim4.jpg"}, {t:"Adƒ±m 5", d:"Bitir", img:"cicek_adim5.jpg"}] },
        castle: { title:"Kale", steps: [{t:"Adƒ±m 1", d:"Yap", img:"kale_adim1.jpg"}, {t:"Adƒ±m 2", d:"Bitir", img:"kale_adim2.jpg"}] },
        animal: { title:"Hayvan", steps: [{t:"Adƒ±m 1", d:"Yap", img:"hayvan_adim1.jpg"}] }
    };

    function startGuide(key) {
        activeGuideKey = key;
        guideStepIndex = 0;
        guidePhotos = new Array(guidesLocal[key].steps.length).fill(null);
        renderStep();
        nav('s-guide-steps');
    }

    function renderStep() {
        const d = guidesLocal[activeGuideKey].steps[guideStepIndex];
        document.getElementById('guide-step-header').innerText = `Adƒ±m ${guideStepIndex + 1}`;
        document.getElementById('guide-step-title').innerText = d.t;
        document.getElementById('guide-step-desc').innerText = d.d;
        document.getElementById('guide-example-img').src = d.img;
        
        const userBox = document.getElementById('guide-user-box');
        const userImg = document.getElementById('guide-user-img');
        if(guidePhotos[guideStepIndex]) {
            userImg.src = guidePhotos[guideStepIndex];
            userBox.style.display = 'flex';
        } else {
            userBox.style.display = 'none';
        }

        const btn = document.getElementById('btn-guide-next');
        const isLast = guideStepIndex === guidesLocal[activeGuideKey].steps.length - 1;
        btn.innerHTML = isLast ? 'Tamamla <i class="fa-solid fa-flag-checkered"></i>' : 'ƒ∞leri <i class="fa-solid fa-arrow-right"></i>';
    }

    function handlePhotoUpload(input) {
        if(input.files && input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                guidePhotos[guideStepIndex] = e.target.result;
                renderStep();
                showToast("Y√ºklendi!", "success");
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function nextStep() {
        if(!guidePhotos[guideStepIndex]) return showToast("Fotoƒüraf y√ºkle!", "error");
        if(guideStepIndex < guidesLocal[activeGuideKey].steps.length - 1) {
            guideStepIndex++;
            renderStep();
        } else {
            // Bitir
            const grid = document.getElementById('summary-grid');
            grid.innerHTML = "";
            guidePhotos.forEach((p, i) => {
                grid.innerHTML += `<div class="card" style="padding:10px;"><img src="${p}" style="width:100%; border-radius:10px;"><b>Adƒ±m ${i+1}</b></div>`;
            });
            nav('s-guide-success');
        }
    }
    function prevStep() {
        if(guideStepIndex > 0) { guideStepIndex--; renderStep(); }
        else nav('s-challenges');
    }
    function claimGuideReward() {
        user.xp += 50;
        save();
        launchConfetti();
        nav('s-rewards');
    }

    // --- UTIL ---
    function showToast(msg, type='neutral') {
        const box = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = msg;
        box.appendChild(t);
        setTimeout(()=>t.classList.add('show'), 10);
        setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, 3000);
    }
    
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function launchConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }

</script>

</body>
</html>
